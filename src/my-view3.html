<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
  <link rel="import" href="../bower_components/polymerfire/firebase-query.html">
  <link rel="import" href="summary-item.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">


<dom-module id="my-view3">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
       .pad {
          padding: 0 16px;
          @apply(--layout-flex);
          @apply(--layout-horizontal);
        }
    </style>
    

      
    <firebase-query
    id="query"
    order-by-child="consumedDate"
    app-name="nephcount"
    path="/consumption"
    data="{{consumption}}">
    </firebase-query>

          <!--start-at="2016-10-15"
    end-at="2016-10-16"-->

      
    <div class="card">
      <h1>Report</h1>
      <h2>Today's totals</h2>
        <!--div>[[printArrayAsJson(todaysNutrients.*)]]</div-->
        <template is="dom-repeat" items="[[todaysNutrients]]">
            <div class="pad">
                <div>[[item.name]]:&nbsp;&nbsp;</div>
                <div>[[item.total]]&nbsp;</div>
                <div>[[item.unit]]</div>
            </div>
        </template>
        <br /><hr />
        <template is="dom-repeat" items="[[consumption]]">
            <summary-item input-item="[[item]]" match-string="[[todayString]]"></summary-item>
        </template>
      <h2>YESTERDAY</h2>
        <div></div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'my-view3',
        properties: {
            consumption : {
                type: Array
            },
            consumptionVisited : {
                type: Object,
                value: {}
                /* seems like I need to clear this after the firebase query comes back */
            },
            todaysNutrients: {
                type: Array,
                value: []
            },
            todayString: {
                type: String,
                value: (new Date()).toISOString().substring(0, 10)
            },
            active: {
                type: Boolean
            }
        },
        observers:[ 'consumptionChanged(consumption.*)',
                    'todaysNutrientsChanged(todaysNutrients.*)'],
        printArrayAsJson: function(changeRecord) {
            return JSON.stringify(changeRecord.base);
        },
        todaysNutrientsChanged: function(changeRecord) {
            console.log("todaysNutrients array changed...");
        },
        consumptionChanged:function(changeRecord) {
            console.log("consumption changed: ");
            if (changeRecord.base.length === 0) {
                return;
            }
            for(var i = changeRecord.base.length - 1; i < changeRecord.base.length && changeRecord.base[i].consumedDate.substring(0, 10) === this.todayString; i++) {
                if (typeof this.consumptionVisited[changeRecord.base[i].$key] == 'undefined') { // only visit each consumption node once
                     this.consumptionVisited[changeRecord.base[i].$key] = true;
                }
                else {
                    return;
                }
                
                var nutrientsOfInterest= changeRecord.base[i].nutrientsOfInterest;
                for(var j = 0; j < nutrientsOfInterest.length; j++) {
                    var noiFound = false;
                    for (var k = 0; k < this.todaysNutrients.length; k++) {
                        if (this.todaysNutrients[k].name === nutrientsOfInterest[j].nutrient) {
                            this.set('todaysNutrients.' + k + '.total', this.todaysNutrients[k].total + nutrientsOfInterest[j].value * changeRecord.base[i].multiplier);
                            noiFound = true;
                            break;
                        }
                    }
                    if (!noiFound && typeof nutrientsOfInterest[j].nutrient != 'undefined') {
                        this.push('todaysNutrients', {"name": nutrientsOfInterest[j].nutrient, "total" : nutrientsOfInterest[j].value * changeRecord.base[i].multiplier, "unit" : nutrientsOfInterest[j].unit});
                    }
                }          
            }
        }
    });
  </script>
</dom-module>
