<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
  <link rel="import" href="../bower_components/polymerfire/firebase-query.html">
  <link rel="import" href="summary-item.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-styles/demo-pages.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">


<dom-module id="my-view3">
  <template>
    <style is="custom-style" include="shared-styles paper-date-picker-dialog-style">
      :host {
        display: block;

        padding: 10px;
      }
       .pad {
          padding: 0 16px;
          @apply(--layout-flex);
          @apply(--layout-horizontal);
        }
    </style>
    

      
    <firebase-query
    id="query"
    order-by-child="consumedDate"
    app-name="nephcount"
    path="/users/[[user.uid]]/consumption"
    data="{{consumption}}">
    </firebase-query>

          <!--start-at="2016-10-15"
    end-at="2016-10-16"-->

      
    <div class="card">
       <paper-input value="[[todayString]]" label="Report Date" placeholder="YYYY-MM-DD"></paper-input>
      <paper-button class="btn" on-tap="_showDialog" raised>Change Date</paper-button>
      <paper-dialog id="dialog" class="paper-date-picker-dialog" on-iron-overlay-closed="_dismissDialog">
        <paper-date-picker id="picker" date="{{selectedDate}}"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
        
        <h1>Report Date Totals</h1>
        <template is="dom-repeat" items="[[_todaysNutrientsOrDateStringChanged(todaysNutrients.*, todayString)]]">
            <div class="pad">
                <div>[[item.name]]:&nbsp;&nbsp;</div>
                <div>[[_formatNumber(item.total)]]&nbsp;</div>
                <div>[[item.unit]]</div>
                <paper-slider value="[[_calculatePercent(item.name,item.total, nutrientsOfInterest)]]"></paper-slider>
                 ([[_displayedAmountLeft(item.name, item.total, nutrientsOfInterest)]] left)
            </div>
        </template>
        
        <br /><hr />
      <h2>Consumed on Report Date</h2>
        <template is="dom-repeat" items="[[_consumptionOrDateChanged(consumption.*, todayString)]]">
            <paper-material elevation="2">
                <summary-item input-item="[[item]]" match-string="[[todayString]]"></summary-item>
            </paper-material>
        </template>
      <!--h2>YESTERDAY</h2>
        <div></div-->
    </div>
  </template>

  <script>
    Polymer({
      is: 'my-view3',
        properties: {
            selectedDate: {
                type: Date
            },
            nutrientsOfInterest: {
                type: Array
            },
            consumption : {
                type: Array
            },
            consumptionVisited : {
                type: Object,
                value: {}
                /* seems like I need to clear this after the firebase query comes back */
            },
            todaysNutrients: {
                type: Array,
                value: []
            },
            todayString: {
                type: String,
                value: formatLocalDate(new Date()).substring(0, 10)
            },
            active: {
                type: Boolean
            }
        },
        observers:[ 'consumptionChanged(consumption.*, todayString)',
                    'todaysNutrientsChanged(todaysNutrients.*)',
                    '_selectedDateChanged(selectedDate)',
                    '_todayStringChanged()'],
        _calculatePercent: function(name, total, nutrientsOfInterest) {
            console.log("_calculatePercent executed...");
            for(var i = 0; i < nutrientsOfInterest.length; i++) {
                if (nutrientsOfInterest[i].name === name) {
                    return total * 100 / nutrientsOfInterest[i].maxAllowedDaily;
                }
            }
            return 0;
        },
        _displayedAmountLeft: function(name, total, nutrientsOfInterest) {
            console.log("_displayedAmountLeft executed...");
            for(var i = 0; i < nutrientsOfInterest.length; i++) {
                if (nutrientsOfInterest[i].name === name) {
                    var num = nutrientsOfInterest[i].maxAllowedDaily - total;
                    return num.toFixed(2) + " " + nutrientsOfInterest[i].maxAllowedDailyUnit;
                }
            }
            return "n/a";
        },
        _formatNumber: function(num) {
            return num.toFixed(2);
        },
        printArrayAsJson: function(changeRecord) {
            return JSON.stringify(changeRecord.base);
        },
        todaysNutrientsChanged: function(changeRecord) {
            console.log("todaysNutrients array changed...");
        },
        consumptionChanged:function(changeRecord, dateString) {
            console.log("consumption changed: ");
            this.splice('todaysNutrients', 0, this.todaysNutrients.length);
            if (changeRecord.base.length === 0 || dateString.length === 0) {
                return;
            }
//            for(var i = changeRecord.base.length - 1; i < changeRecord.base.length && changeRecord.base[i].consumedDate.substring(0, 10) === this.todayString; i++) {
            for(var i = 0; i < changeRecord.base.length; i++) {
                if (changeRecord.base[i].consumedDate.substring(0, 10) !== this.todayString) {
                    continue;
                }
//                if (typeof this.consumptionVisited[changeRecord.base[i].$key] == 'undefined') { // only visit each consumption node once
//                     this.consumptionVisited[changeRecord.base[i].$key] = true;
//                }
//                else {
//                    return;
//                }
                
                var nutrientsOfInterest= changeRecord.base[i].nutrientsOfInterest;
                for(var j = 0; j < nutrientsOfInterest.length; j++) {
                    var noiFound = false;
                    for (var k = 0; k < this.todaysNutrients.length; k++) {
                        if (this.todaysNutrients[k].name === nutrientsOfInterest[j].nutrient) {
                            this.set('todaysNutrients.' + k + '.total', this.todaysNutrients[k].total + getUnavailableValue(nutrientsOfInterest[j].value) * changeRecord.base[i].multiplier);
                            noiFound = true;
                            break;
                        }
                    }
                    if (!noiFound && typeof nutrientsOfInterest[j].nutrient != 'undefined') {
                        this.push('todaysNutrients', {"name": nutrientsOfInterest[j].nutrient, "total" : getUnavailableValue(nutrientsOfInterest[j].value) * changeRecord.base[i].multiplier, "unit" : nutrientsOfInterest[j].unit});
                    }
                }          
            }
        },
        _selectedDateChanged: function(selectedDate) {
            console.log("selected date changed to " + selectedDate);
        },
        _showDialog: function() {
            this.$.dialog.toggle();
        },
        _dismissDialog : function(event) {
            if (event.detail.confirmed) {
              this.todayString = formatLocalDate(this.$.picker.date).substring(0, 10);
            }
        },
        _todayStringChanged:  function(dateString) {
        },
        _consumptionOrDateChanged: function(changeRecord, dateString) {
            if (changeRecord.base.length > 0 &&
                dateString.length > 0) {
                return changeRecord.base;
            }
        },
        _todaysNutrientsOrDateStringChanged: function(changeRecord, dateString) {
            if (changeRecord.base.length > 0 &&
                dateString.length > 0) {
                return changeRecord.base;
            }

        }
    });
      
    function formatLocalDate(theDate) {
        var now = theDate,
            tzo = -now.getTimezoneOffset(),
            dif = tzo >= 0 ? '+' : '-',
            pad = function(num) {
                var norm = Math.abs(Math.floor(num));
                return (norm < 10 ? '0' : '') + norm;
            };
        return now.getFullYear() 
            + '-' + pad(now.getMonth()+1)
            + '-' + pad(now.getDate())
            + 'T' + pad(now.getHours())
            + ':' + pad(now.getMinutes()) 
            + ':' + pad(now.getSeconds()) 
            + dif + pad(tzo / 60) 
            + ':' + pad(tzo % 60);
       };
      function getUnavailableValue(value) {
          if (value === "--") {
              return 0;
          }
          else {
              return value;
          }
      }

  </script>
</dom-module>
