<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
  <link rel="import" href="../bower_components/polymerfire/firebase-query.html">
  <link rel="import" href="summary-item.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-styles/demo-pages.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">


<dom-module id="my-view3">
  <template>
    <style is="custom-style" include="shared-styles paper-date-picker-dialog-style">
      :host {
        display: block;

        padding: 10px;
      }
       .pad {
          padding: 0 16px;
          @apply(--layout-flex);
          @apply(--layout-horizontal);
        }
    paper-button {
      width: 45%;
      margin-top: 20px;
    }
    paper-button:not([disabled]) {
      background: var(--paper-light-blue-500);
      color: white;
    }
    .iron-selected {
      background: #eee;
    }

      </style>
    

      
    <firebase-query
    id="query"
    order-by-child="consumedDate"
    start-at="[[todayStringStart]]"
    end-at="[[todayStringEnd]]"
    app-name="nephcount"
    path="/users/[[user.uid]]/consumption"
    data="{{consumption}}">
    </firebase-query>

          <!--start-at="2016-10-15"
    end-at="2016-10-16"-->

    <firebase-document id="fbdoc"
          app-name="nephcount"
         path="/users/[[user.uid]]/customFood"
          data="{{customFood}}">
      </firebase-document>

      
    <div class="card">
       <paper-input value="[[todayString]]" label="Report Date" placeholder="YYYY-MM-DD"></paper-input>
      <paper-button class="btn" on-tap="_showDialog" raised>Change Date</paper-button>
      <paper-dialog id="dialog" class="paper-date-picker-dialog" on-iron-overlay-closed="_dismissDialog">
        <paper-date-picker id="picker" date="{{selectedDate}}"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
        
        <h1>Report Date Totals</h1>
        <template is="dom-repeat" items="[[_todaysNutrientsOrDateStringChanged(todaysNutrients.*, todayString)]]">
            <div class="pad">
                <div>[[item.name]]:&nbsp;&nbsp;</div>
                <div>[[_formatNumber(item.total)]]&nbsp;</div>
                <div>[[item.unit]]</div>
                <paper-slider value="[[_calculatePercent(item.name,item.total, nutrientsOfInterest)]]"></paper-slider>
                 ([[_displayedAmountLeft(item.name, item.total, nutrientsOfInterest)]] left)
            </div>
        </template>
        
        <br /><hr />
      <h2>Consumed on Report Date</h2>
        <iron-selector multi selected-values="{{selectedConsumedValues}}">
            <template is="dom-repeat" items="[[_consumptionOrDateChanged(consumption.*, todayString)]]">
                <paper-material elevation="2">
                    <summary-item input-item="[[item]]" match-string="[[todayString]]"></summary-item>
                </paper-material>
            </template>
        </iron-selector>
<paper-toolbar>
  <span class="title">Actions</span>
  <paper-icon-button on-tap="_openCompositeCustomFoodDialog" icon="favorite"></paper-icon-button>
</paper-toolbar>

      <paper-dialog id="compositeCustomFoodDialog" on-iron-overlay-closed="_dismissCompositeCustomFoodDialog">
          <h2>Composite Custom Food</h2>
        <paper-input value="{{compositeCustomFoodName}}" label="Name" required></paper-input>
        <paper-input value="{{compositeCustomFoodMeasure}}" label="Measure" required></paper-input>
        <paper-input value="[[compositeCustomFoodWeight]]" label="Weight in grams" read-only></paper-input>          
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>      
      
      </div>
  </template>

  <script>
    Polymer({
      is: 'my-view3',
        properties: {
            selectedDate: {
                type: Date
            },
            nutrientsOfInterest: {
                type: Array
            },
            consumption : {
                type: Array
            },
            consumptionVisited : {
                type: Object,
                value: {}
                /* seems like I need to clear this after the firebase query comes back */
            },
            todaysNutrients: {
                type: Array,
                value: []
            },
            todayString: {
                type: String,
                value: formatLocalDate(new Date()).substring(0, 10)
            },
            todayStringStart: {
                type: String,
                value: formatLocalDate(new Date()).substring(0, 10) + "T00:00:00"
            },
            todayStringEnd: {
                type: String,
                value: formatLocalDate(new Date()).substring(0, 10) + "T23:59:59"
            },
            active: {
                type: Boolean
            },
            selectedConsumedValues: Array,
            compositeCustomFoodName: String,
            compositeCustomFoodMeasure: String,
            compositeCustomFoodWeight: Number
        },
        observers:[ 'consumptionChanged(consumption.*, todayString)',
                    '_selectedDateChanged(selectedDate)',
                 '_selectedConsumedValuesChanged(selectedConsumedValues.*)'],
        _calculatePercent: function(name, total, nutrientsOfInterest) {
            console.log("_calculatePercent executed...");
            for(var i = 0; i < nutrientsOfInterest.length; i++) {
                if (nutrientsOfInterest[i].name === name) {
                    return total * 100 / nutrientsOfInterest[i].maxAllowedDaily;
                }
            }
            return 0;
        },
        _displayedAmountLeft: function(name, total, nutrientsOfInterest) {
            console.log("_displayedAmountLeft executed...");
            for(var i = 0; i < nutrientsOfInterest.length; i++) {
                if (nutrientsOfInterest[i].name === name) {
                    var num = nutrientsOfInterest[i].maxAllowedDaily - total;
                    return num.toFixed(2) + " " + nutrientsOfInterest[i].maxAllowedDailyUnit;
                }
            }
            return "n/a";
        },
        _formatNumber: function(num) {
            return num.toFixed(2);
        },
        printArrayAsJson: function(changeRecord) {
            return JSON.stringify(changeRecord.base);
        },
        consumptionChanged:function(changeRecord, dateString) {
            console.log("consumption changed: ");
            this.splice('todaysNutrients', 0, this.todaysNutrients.length);
            if (changeRecord.base.length === 0 || dateString.length === 0) {
                return;
            }
            for(var i = 0; i < changeRecord.base.length; i++) {
                if (changeRecord.base[i].consumedDate.substring(0, 10) !== this.todayString) {
                    continue;
                }                
                var nutrientsOfInterest= changeRecord.base[i].nutrientsOfInterest;
                for(var j = 0; j < nutrientsOfInterest.length; j++) {
                    var noiFound = false;
                    for (var k = 0; k < this.todaysNutrients.length; k++) {
                        if (this.todaysNutrients[k].name === nutrientsOfInterest[j].nutrient) {
                            this.set('todaysNutrients.' + k + '.total', this.todaysNutrients[k].total + getUnavailableValue(nutrientsOfInterest[j].value) * changeRecord.base[i].multiplier);
                            noiFound = true;
                            break;
                        }
                    }
                    if (!noiFound && typeof nutrientsOfInterest[j].nutrient != 'undefined') {
                        this.push('todaysNutrients', {"name": nutrientsOfInterest[j].nutrient, "total" : getUnavailableValue(nutrientsOfInterest[j].value) * changeRecord.base[i].multiplier, "unit" : nutrientsOfInterest[j].unit});
                    }
                }          
            }
        },
        _selectedDateChanged: function(selectedDate) {
            console.log("selected date changed to " + selectedDate);
        },
        _showDialog: function() {
            this.$.dialog.toggle();
        },
        _dismissDialog : function(event) {
            if (event.detail.confirmed) {
              this.todayString = formatLocalDate(this.$.picker.date).substring(0, 10);
              this.todayStringStart = this.todayString + "T00:00:00";
              this.todayStringEnd = this.todayString + "T23:59:59";
            }
        },
        _consumptionOrDateChanged: function(changeRecord, dateString) {
            if (changeRecord.base.length > 0 &&
                dateString.length > 0) {
                return changeRecord.base;
            }
        },
        _todaysNutrientsOrDateStringChanged: function(changeRecord, dateString) {
            if (changeRecord.base.length > 0 &&
                dateString.length > 0) {
                return changeRecord.base;
            }

        },
        _selectedConsumedValuesChanged: function(changeRecord) {
            console.log("selected consumed values changed...");
        },
        _openCompositeCustomFoodDialog: function(event) {
            this.$.compositeCustomFoodDialog.toggle();
            // calculate weight
            this.compositeCustomFoodWeight = 0; 
            for (var i = 0; i < this.selectedConsumedValues.length; i++) {
                this.compositeCustomFoodWeight += this.consumption[this.selectedConsumedValues[i]].weight;
            }
        },
        _dismissCompositeCustomFoodDialog: function(event) {
            if (event.detail.confirmed) {
                var newObject = {
                    "ndbno": "01131",
                    "name": "Egg, whole, cooked, poached",
                    "weight": 50.0,
                    "measure": "1.0 large",
                    "nutrients": [],
                    "components": []
                };
                newObject.name = this.compositeCustomFoodName;
                newObject.ndbno = "-1";
                newObject.measure = this.compositeCustomFoodMeasure;
                newObject.weight = this.compositeCustomFoodWeight;

                var nutrientsArray = [];
                for (var i = 0; i < this.selectedConsumedValues.length; i++) {
                    // TODO this components push cannot contain $key in it, so 
                    // copy it removing this property.
//                    newObject.components.push(this.consumption[this.selectedConsumedValues[i]]);
                    var currentNutrients = this.consumption[this.selectedConsumedValues[i]].nutrientsOfInterest;
                    for(var j = 0; j < currentNutrients.length; j++) {
                        var currentValue = currentNutrients[j].value * this.consumption[this.selectedConsumedValues[i]].multiplier;
                        if (i === 0) {
                            currentNutrients[j].value = currentValue;
                            nutrientsArray.push(currentNutrients[j]);
                        }
                        else {
                            for (var k = 0; k < nutrientsArray.length; k++) {
                                if (nutrientsArray[k].nutrient_id === currentNutrients[j].nutrient_id) {
                                    nutrientsArray[k].value += currentValue;
                                    break;
                                }   
                            }
                        }
                    }
                }
                newObject.nutrients = nutrientsArray;
                console.log("done constructing new Object...");
                this.push('customFood', newObject);
                this.foodName = null;
                this.ndbno = null;
                this.measure = null;
                this.weight = null;
                this.foodNutrients = [];
            }
        }
    });
      
    function formatLocalDate(theDate) {
        var now = theDate,
            tzo = -now.getTimezoneOffset(),
            dif = tzo >= 0 ? '+' : '-',
            pad = function(num) {
                var norm = Math.abs(Math.floor(num));
                return (norm < 10 ? '0' : '') + norm;
            };
        return now.getFullYear() 
            + '-' + pad(now.getMonth()+1)
            + '-' + pad(now.getDate())
            + 'T' + pad(now.getHours())
            + ':' + pad(now.getMinutes()) 
            + ':' + pad(now.getSeconds()) 
            + dif + pad(tzo / 60) 
            + ':' + pad(tzo % 60);
       };
      function getUnavailableValue(value) {
          if (value === "--") {
              return 0;
          }
          else {
              return value;
          }
      }

  </script>
</dom-module>
