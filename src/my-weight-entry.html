<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/nvd3-elements/nvd3-line.html">

<dom-module id="my-weight-entry">
    <template>
    <style is="custom-style" include="shared-styles paper-date-picker-dialog-style">
      :host {
        display: block;

        padding: 10px;
      }
       .pad {
          padding: 0 16px;
          @apply(--layout-flex);
          @apply(--layout-horizontal);
        }
    paper-button {
      width: 45%;
      margin-top: 20px;
    }
    paper-button:not([disabled]) {
      background: var(--paper-light-blue-500);
      color: white;
    }

      </style>
<!--
        <firebase-auth user="{{user}}">
        </firebase-auth>
-->
        <firebase-query id="query" 
                        app-name="nephcount"
                        order-by-child="theDate"
                        path="[[_assembleQueryWeightPath(user.uid)]]"
                        data="{{weights}}">
        </firebase-query>
        
        <div id="card">
     <h1>Weight Entry</h1>
<nvd3-line 
data="[[data]]"
  height="50"
  width="50"
  auto-resize
  show-legend
  use-interactive-guideline>
</nvd3-line>
            <div id="weights">
                <ul id="weights-list">
                    <template is="dom-repeat" items="[[weights]]" as="weight">
                        <li>
                            <p class="content"> [[weight.theDate]],[[weight.weight]] </p>
                        </li>
                    </template>
                </ul>
                
        <paper-input id="inputDate" label="Date" value="[[todayString]]" placeholder="YYYY-MM-DD"></paper-input>
      <paper-button class="btn" on-tap="_showDialog" raised>Change Date</paper-button>
      <paper-dialog id="dialog" class="paper-date-picker-dialog" on-iron-overlay-closed="_dismissDialog">
        <paper-date-picker id="picker" date="{{selectedDate}}"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
                
                <paper-input id="inputWeight" label="Weight"></paper-input><div> lbs</div>

                <div id="weights-controls">
                    <paper-button id="add" on-tap="add">Add</paper-button>
                </div>
            </div>
        </div>
    </template>
    
    <script>
        Polymer({
            is:'my-weight-entry',
            properties: {
                user: Object,
                selectedDate: Date,
                weights: {
                    type: Object,     
                },
                todayString: {
                    type: String,
                    value: function() {
                        return this._formatLocalDate(new Date()).substring(0, 10);
                    }
                },
                data: {
                    type: Array,
                    value: [
  {
    "key": "Sine Wave",
    "color": "#ff7f0e",
    "values": [{
      "x": 0,
      "y": 0
    }, {
      "x": 1,
      "y": 0.09983341664682815
    }, {
      "x": 2,
      "y": 0.19866933079506122
    }, {
      "x": 3,
      "y": 0.29552020666133955
    }, {
      "x": 4,
      "y": 0.3894183423086505
    }, {
      "x": 5,
      "y": 0.479425538604203
    }]
  }, {
    "key": "Cosine Wave",
    "color": "#2ca02c",
    "values": [{
      "x": 0,
      "y": 0.5
    }, {
      "x": 1,
      "y": 0.49750208263901285
    }, {
      "x": 2,
      "y": 0.4900332889206208
    }, {
      "x": 3,
      "y": 0.477668244562803
    }, {
      "x": 4,
      "y": 0.46053049700144255
    }, {
      "x": 5,
      "y": 0.4387912809451864
    }]
  }
]
                }
            },
            observers: ['userChanged(user.*)'],
            add: function() {
                this.$.query.ref.push({
                    theDate: this.$.inputDate.value,
                    weight: this.$.inputWeight.value
                });
                this.$.inputDate.value = null;
                this.$.inputWeight.value = null;
            },
            userChanged:  function(changeRecord) {
                console.log("user has changed... ");
            },
            _assembleQueryUserPath:  function(newValue, oldValue) {
                return "/users/" + newValue;
            },
            _assembleQueryWeightPath:  function(newValue, oldValue) {
                return "/users/" + newValue + "/weights";
            },
            _formatLocalDate: function (theDate) {
                    var now = theDate,
                        tzo = -now.getTimezoneOffset(),
                        dif = tzo >= 0 ? '+' : '-',
                        pad = function(num) {
                            var norm = Math.abs(Math.floor(num));
                            return (norm < 10 ? '0' : '') + norm;
                        };
                    return now.getFullYear() 
                        + '-' + pad(now.getMonth()+1)
                        + '-' + pad(now.getDate())
                        + 'T' + pad(now.getHours())
                        + ':' + pad(now.getMinutes()) 
                        + ':' + pad(now.getSeconds()) 
                        + dif + pad(tzo / 60) 
                        + ':' + pad(tzo % 60);
            },
            _showDialog: function() {
                this.$.dialog.opened = true;
            },
            _dismissDialog : function(event) {
                if (event.detail.confirmed) {
                  this.todayString = this._formatLocalDate(this.$.picker.date).substring(0, 10);
                }
            }
        })
    </script>
</dom-module>