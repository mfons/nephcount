<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-demo-helpers/demo-snippet.html">
  <link rel="import" href="../bower_components/iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">
  <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
  <link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
  <link rel="import" href="../bower_components/paper-input/paper-input.html">
  <link rel="import" href="../bower_components/paper-item/paper-item.html">
  <link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
  <link rel="import" href="../bower_components/paper-menu/paper-menu.html">
  <link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
  <link rel="import" href="../bower_components/paper-styles/color.html">
  <link rel="import" href="../bower_components/paper-styles/typography.html">
  <link rel="import" href="../bower_components/iron-form/iron-form.html">
  <link rel="import" href="../bower_components/iron-list/iron-list.html">
  <link rel="import" href="../bower_components/polymerfire/firebase-query.html">
  <link rel="import" href="simple-element.html">
  <link rel="import" href="nutrients-for-food-service.html">
  <link rel="import" href="foods-by-text-search.html">
  <link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
  <link rel="import" href="../bower_components/iron-icon/iron-icon.html">
  <link rel="import" href="my-icons.html">
  <link rel="import" href="../bower_components/paper-fab/paper-fab.html">
  <link rel="import" href="nephcount-behaviors.html">
  <link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="alter-food-nutrient-amounts.html">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">



<dom-module id="my-view2">
  <template>
   <style is="custom-style" include="demo-pages-shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    .output {
      margin-top: 20px;
      word-wrap: break-word;
      @apply(--paper-font-common-code);
    }
    paper-button, paper-icon-button {
      width: 45%;
      margin-top: 20px;
    }
    paper-button:not([disabled]),  paper-icon-button:not([disabled]) {
      background: var(--paper-light-blue-500);
      color: white;
    }
    paper-fab.label {
        font-size: 20px;
    }
    paper-fab {
         position:absolute;
         right:0px;
    }
    paper-fab.blue {
        --paper-fab-background: var(--paper-blue-500);
        --paper-fab-keyboard-focus-background: var(--paper-blue-900);
    }
    button {
      margin-top: 20px;
    }
    paper-spinner {
      width: 14px;
      height: 14px;
      margin-right: 20px;
    }
    paper-dropdown-menu {
      display: block;

    }
    demo-snippet {
      --demo-snippet-code: {
        max-height: 300px;
      };
    }
    iron-list {
      flex: 1 1 auto;
    }
       .pad {
          padding: 0 16px;
          @apply(--layout-flex);
          @apply(--layout-horizontal);
        }
     </style>

     <nutrients-for-food-service food-id="[[foodId]]" food-name="[[foodName]]"
            nutrients-of-interest="[[nutrientsOfInterest]]"
            food-nutrients="{{foodNutrients}}"
            custom-foods="[[customFoods]]">
      </nutrients-for-food-service>

      <foods-by-text-search text-search="[[textSearch]]" foods="{{foods}}"
                            user="[[user]]" id="foodsByTextSearch"
                            custom-foods="{{customFoods}}" is-standard-reference="[[isStandardReference]]">
      </foods-by-text-search>

      <firebase-query id="consumptionsQuery"
                      start-at="[[todayStringStart]]"
                      end-at="[[todayStringEnd]]"
                      order-by-child="consumedDate"
                      path="[[_assembleQueryConsumptionsPath(user.uid)]]"
                      data="{{consumptions}}">
      </firebase-query>


        <firebase-query id="query"
                        order-by-child="theDate"
                        path="[[_assembleQueryDrinkPath(user.uid)]]"
                        data="{{drinks}}">
        </firebase-query>


      <paper-fab class="blue" icon="my-svg-icons:local-drink" id="registerLiquidFab" title="Click on this every time you drink a 10 oz of fluid."></paper-fab>

      <div class="vertical-section-container centered">
     <h1>Enter Food/Fluid</h1>
       <form is="iron-form" method="get" action="/" id="presubmit">
          <paper-toggle-button checked="{{isStandardReference}}">
              Use Standard Reference
           </paper-toggle-button>
          <paper-input id="foodFluidSearchStringId" name="foodFluidSearch" label="Search Food/Fluid" value="{{foodFluidSearchString}}" required autocapitalize="off"></paper-input>
          <paper-dropdown-menu required on-tap="_foodSelectionMenuTapped" label="Food/Fluid" id="foodSelectionMenu">
            <paper-listbox class="dropdown-content" selected="{{selectedFood}}" id="foodSelectionListbox">
             <template is="dom-repeat" items='[[foods]]' as="foodItem">
                <paper-item>[[foodItem.name]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
            <!-- usda api:  https://ndb.nal.usda.gov/ndb/doc/index -->
            <!-- get a list of food groups:  https://api.nal.usda.gov/ndb/list?format=json&lt=g&sort=n&api_key=DEMO_KEY -->

          <paper-input name="measure" label="Serving size" readonly="true" value="[[measure]]"></paper-input>
          <paper-input name="weight" label="Weight in grams" readonly="true" value="[[weight]]"></paper-input>
          <paper-input name="multiplier" type="number" step="any" label="Multiplier" value="{{multiplier}}" required></paper-input>
          <paper-input name="consumedGrams" label="Consumed grams" value="{{consumedGrams}}" required></paper-input>
          <paper-icon-button icon="my-svg-icons:local-dining" raised onclick="_submit(event)" title="Consume"></paper-icon-button>
          <paper-icon-button icon="my-svg-icons:clear" raised onclick="_reset(event)" title="Reset"></paper-icon-button>
        </form>
        <div class="card">
          <h2>Nutrients Of Interest</h2>
          <iron-list items="[[_getNutrientsFromFoodNutrients(foodNutrients.*)]]">
            <template>
              <div class="pad">
                  <div>[[item.nutrient]]:&nbsp;&nbsp;</div>
                  <div>[[_applyMultiplier(item.value, multiplier)]]&nbsp;</div>
                  <div>[[item.unit]]</div>
              </div>
            </template>
          </iron-list>

            <paper-icon-button icon="my-svg-icons:edit" raised on-tap="_editNutrients"></paper-icon-button>
        </div>
        <paper-dialog id="editConsumptionNutrientsDialog">
          <alter-food-nutrient-amounts
                food-nutrients="[[_getNutrientsFromFoodNutrients(foodNutrients.*)]]"
                multiplier="[[multiplier]]"
                altered-nutrients="{{alteredNutrients}}">
          </alter-food-nutrient-amounts>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm autofocus>Save Nutrients</paper-button>
          </div>
        </paper-dialog>

      </div>
  </template>

  <script>


    Polymer({
      is: 'my-view2',
      behaviors: [NephcountBehaviors.DateBehavior],
        properties: {
            isStandardReference: {
                type: Boolean,
                value: true
            },
            drinks: Object,
            nutrientsOfInterest: {
                type: Array
            },
            foodNutrients: {
                type: Object
            },
            textSearch: {
                type: String,
                value: "butter"
            },
            foods: {
                type: Array
            },
            selectedFood: {
                type: Object,
                observer: 'selectedFoodChanged'
            },
            foodFluidSearchString: {
                type: String,
                observer: 'foodFluidSearchStringChanged'
            },
            foodId: String,
            foodName: String,
            measure: String,
            weight: Number,
            multiplier: Number,
            consumedGrams: {
                type:  Number,
                computed: 'calculateConsumedGrams(weight, multiplier)'
            },
            consumptions: Array,
            alteredNutrients: Array
        },
        observers: [
             'foodNutrientsChanged(foodNutrients.*)',
             'foodIdChanged(foodId)',
             '_isStandardReferenceChanged(isStandardReference)'],
        listeners: {
            'presubmit.iron-form-presubmit': 'myPreSubmit',
            'presubmit.iron-form-submit': 'mySubmit',
            'foodSelectionMenu.tap' : '_foodSelectionMenuTap',
            'registerLiquidFab.tap':'_registerLiquid',
            'editConsumptionNutrientsDialog.iron-overlay-closed': '_editConsumptionNutrientsDialogClosed'
        },
        myPreSubmit : function(event) {
            event.preventDefault;
             console.log("myPreSubmit() function executed");
             this._consume();
          },
        mySubmit : function(event) {
          },
        printAsJson: function(jsonObject) {
            return JSON.stringify(jsonObject);
        },
        _foodSelectionMenuTapped: function(event) {
          this.selectedFood = null;  // no default value please
        },
        _getNutrientsFromFoodNutrients: function(changeRecord) {
          if (changeRecord.base.length > 0) {
            this.notifyPath('foodNutrients.0.nutrients');
            return changeRecord.base[0].nutrients;
          }
          return [];
        },
        _editConsumptionNutrientsDialogClosed: function(event) {
          if (event.detail.confirmed) {
            // Alter alteredNutrients to have non-multiplied nutrient value.
            for (var i = 0; i < this.alteredNutrients.length; i++) {
              this.set('alteredNutrients.' + i + '.value', ((this.alteredNutrients[i].value === "--") ? "--" : this.alteredNutrients[i].value / this.multiplier));
            }

            // When alteredNutrients are changed then change foodNutrients
            // as well.
            this.splice('foodNutrients.0.nutrients', 0, this.foodNutrients[0].nutrients.length);
            for (var i = 0; i < this.alteredNutrients.length; i++) {
              this.push('foodNutrients.0.nutrients', this.alteredNutrients[i]);
            }

            // Force data system to pick up array mutations...
            // Note:  I did this because I could not figure out how
            // to refresh the screen any other way.  Generally this
            // technique can be quite expensive, and should be avoided.
            // Normal path notification techniques should be used first!
            var fnArray = this.foodNutrients;
            this.foodNutrients = [];
            this.foodNutrients = fnArray;
            // *********** end data system force *********** //
          }
          else if (event.detail.cancelled) {
            // do nothing...
          }
        },
        selectedFoodChanged: function(newObject,oldObject) {
            console.log("my-view2:  selectedFood has changed: " + newObject);
            if (typeof newObject === "undefined" || newObject === null) {
              return;
            }
            this.set('foodId',this.foods[newObject].ndbno);
            this.set('foodName', this.foods[newObject].name);
        },
        foodFluidSearchStringChanged:  function (newString, oldString) {
            this.set('textSearch', newString);
        },
        foodNutrientsChanged: function(changeRecord) {
            if (changeRecord.base.length > 0) {
                this.set('measure', changeRecord.base[0].measure);
                this.set('weight', changeRecord.base[0].weight);
                // TODO create "no-data"
            }
        },
        calculateConsumedGrams: function(weight, multiplier) {
            return weight * multiplier;
        },
        foodIdChanged: function(newObject, oldObject) {
            console.log("foodIdChanged fired...");
        },
        _applyMultiplier:  function(nutrientValue, multiplier) {
            if (nutrientValue === "--") {
                return "[Value Not Available]";
            }
            return (nutrientValue * multiplier).toFixed(2);
        },
        _foodSelectionMenuTap: function(event) {
            console.log('foodSelectionMenu focus occurred...');
            this.$.foodsByTextSearch.mergeCustomAndUSDAFoods();
            this.$.foodSelectionMenu.open();
        },
        _isStandardReferenceChanged : function(newValue, oldValue) {
            console.log("isStandardReference value change from " + oldValue + " to " + newValue);
        },
        _consume: function() {
          var newObject = {
              "name" : "example food3",
              "ndbid" : "00002",
              "nutrientsOfInterest" : [{
                "value" : 0,
                "name" : "example nutrient",
                "nutrientId" : 0,
                "uofm" : "oz"
              }],
              "measure" : "1 serving size",
              "weight" : 15,
              "multiplier" : 1,
              "consumedGrams" : 15,
              "consumedDate" : null
            };
          newObject.name = this.foods[this.selectedFood].name;
          newObject.ndbid = this.foods[this.selectedFood].ndbno;
          newObject.measure = this.measure;
          newObject.weight = this.weight;
          newObject.multiplier = this.multiplier;
          newObject.consumedGrams = this.consumedGrams;
          newObject.consumedDate = this._formatLocalDate(new Date());
          newObject.nutrientsOfInterest = this.foodNutrients[0].nutrients;
            this.$.consumptionsQuery.ref.push(newObject);
        },
        _registerLiquid: function(event) {
                var found = false;
                if (typeof this.drinks != 'undefined' && this.drinks.length > 0) {
                    for (var i = 0; i < this.drinks.length; i++) {
                        if (this.drinks[i].theDate === this.todayString) {
                            var updateRef = this.$.query.ref.child(this.drinks[i].$key);
                            updateRef.once('value').then(function(snapshot) {
                                updateRef.update({
                                    theCount:snapshot.val().theCount + 1
                                });
                            });
                            found = true;
                            break;
                        }
                    }
                }
                if (!found) {
                    this.$.query.ref.push({
                        theDate: this.todayString,
                        theCount: 1
                    });
                }
        },
        _assembleQueryDrinkPath:  function(newValue, oldValue) {
                return "/users/" + newValue + "/drinks";
        },
        _assembleQueryConsumptionsPath:  function(newValue, oldValue) {
            return "/users/" + newValue + "/consumption";
        },
        _editNutrients: function(event) {
          this.$.editConsumptionNutrientsDialog.opened = true;
        }
    });

       function _submit  (event) {
           Polymer.dom(event).localTarget.parentElement.submit();
           _reset(event);
           console.log("_submit function executed");
        };
       function _reset (event) {
            var form = Polymer.dom(event).localTarget.parentElement
            form.reset();
            //form.querySelector('.output').innerHTML = '';
           console.log("_reset() function executed");
        };


</script>
</dom-module>
