<link rel="import" href="../bower_components/polymer/polymer.html">
  <link rel="import" href="../bower_components/polymerfire/firebase-document.html">
  <link rel="import" href="summary-item.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<!--
  <link rel="import" href="../bower_components/paper-styles/color.html">
  <link rel="import" href="../bower_components/paper-styles/typography.html">
  <link rel="import" href="../bower_components/paper-styles/default-theme.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
-->
<link rel="import" href="../bower_components/paper-styles/demo-pages.html">

<!--
`consumed-on-report-date`
This element provides a list of consumed  items and relevant information thereabout,  each of which are selectable and can be acted upon.

@demo demo/index.html 
-->

<dom-module id="consumed-on-report-date">
  <template>
    <style is="custom-style" include="shared-styles">
      :host {
        display: block;
      }
    paper-button {
      width: 45%;
      margin-top: 20px;
    }
    paper-button:not([disabled]) {
      background: var(--paper-light-blue-500);
      color: white;
    }
    .iron-selected {
      background: #eee;
    }
    </style>
    <firebase-document id="fbdocEditableConsumption"
          app-name="nephcount"
         path="/users/[[user.uid]]/consumption"
          data="{{editableConsumption}}">
      </firebase-document>
      
    <firebase-document id="fbdoc"
          app-name="nephcount"
         path="/users/[[user.uid]]/customFood"
          data="{{customFood}}">
      </firebase-document>
      
      <h2>Consumed on Report Date</h2>
        <iron-selector multi selected-values="{{selectedConsumedValues}}">
            <template id="consumedOnReportDateDomRepeatTemplate" is="dom-repeat" items="[[_consumptionOrDateChanged(consumption.*, todayString)]]">
                <paper-material elevation="2">
                    <summary-item input-item="[[item]]" match-string="[[todayString]]"></summary-item>
                </paper-material>
            </template>
        </iron-selector>
<!--<paper-toolbar>-->
<!--  <span class="title">Actions</span>-->
  <paper-button on-tap="_openCompositeCustomFoodDialog" >Save to Combo Food</paper-button>
  <paper-button on-tap="_openDeleteSelectedDialog" >Delete Selected</paper-button>
<!--</paper-toolbar>-->

      <paper-dialog id="compositeCustomFoodDialog" on-iron-overlay-closed="_dismissCompositeCustomFoodDialog">
          <h2>Composite Custom Food</h2>
        <paper-input value="{{compositeCustomFoodName}}" label="Name" required></paper-input>
        <paper-input value="{{compositeCustomFoodMeasure}}" label="Measure" required></paper-input>
        <paper-input value="[[compositeCustomFoodWeight]]" label="Weight in grams" read-only></paper-input>          
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog> 
        
      <paper-dialog id="deleteSelectedConsumptionsDialog" on-iron-overlay-closed="_dismissDeleteSelectedConsumptionDialog">
          <h2>Delete all the selected items?</h2>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
      
      <paper-toast id="deleteToast" duration="6000" text="Refresh browser to see delete change...(sorry)"></paper-toast>
  </template>
    
  <script>
    Polymer({

      is: 'consumed-on-report-date',

      properties: {
        selectedConsumedValues: Array,
        consumption: Array,
        todayString: {
                type: String,
                value: function() { 
                    return this.formatLocalDate(new Date()).substring(0, 10); 
                }
        },
        compositeCustomFoodName: String,
        compositeCustomFoodMeasure: String,
        compositeCustomFoodWeight: Number,
        editableConsumption: Array

      },
      observers: ['_selectedConsumedValuesChanged(selectedConsumedValues.*)'],
    _selectedConsumedValuesChanged: function(changeRecord) {
            console.log("selected consumed values changed...");
    },
    _openCompositeCustomFoodDialog: function(event) {
        this.$.compositeCustomFoodDialog.toggle();
        // calculate weight
        this.compositeCustomFoodWeight = 0; 
        for (var i = 0; i < this.selectedConsumedValues.length; i++) {
            this.compositeCustomFoodWeight += this.consumption[this.selectedConsumedValues[i]].weight;
        }
    },
    _openDeleteSelectedDialog: function(event) {
        this.$.deleteSelectedConsumptionsDialog.opened = true;
    },
    _dismissCompositeCustomFoodDialog: function(event) {
        if (event.detail.confirmed) {
            var newObject = {
                "ndbno": "01131",
                "name": "Egg, whole, cooked, poached",
                "weight": 50.0,
                "measure": "1.0 large",
                "nutrients": [],
                "components": []
            };
            newObject.name = this.compositeCustomFoodName;
            newObject.ndbno = "-1";
            newObject.measure = this.compositeCustomFoodMeasure;
            newObject.weight = this.compositeCustomFoodWeight;

            newObject.components = this._getSelectedListFromConsumed();
            var nutrientsArray = [];   
            for (var i = 0; i < newObject.components.length; i++) {
                var currentNutrients = newObject.components[i].nutrientsOfInterest;
                for(var j = 0; j < currentNutrients.length; j++) {
                    var currentValue = this.getUnavailableValue(currentNutrients[j].value) * newObject.components[i].multiplier;
                    if (i === 0) {
                        currentNutrients[j].value = currentValue;
                        nutrientsArray.push(currentNutrients[j]);
                    }
                    else {
                        for (var k = 0; k < nutrientsArray.length; k++) {
                            if (nutrientsArray[k].nutrient_id === currentNutrients[j].nutrient_id) {
                                nutrientsArray[k].value += currentValue;
                                break;
                            }   
                        }
                    }
                }
            }


            newObject.nutrients = nutrientsArray;
            console.log("done constructing new Object...");
            this.push('customFood', newObject);

            // clear the dialog
            this.foodName = null;
            this.ndbno = null;
            this.measure = null;
            this.weight = null;
            this.foodNutrients = [];
            this.compositeCustomFoodName = "";
            this.compositeCustomFoodMeasure = "";
            this.compositeCustomFoodWeight = 0;
        }
    },
    _dismissDeleteSelectedConsumptionDialog: function() {
        if (!event.detail.confirmed) {
            return;
        }
        var baseIndex = this._getBaseIndexForCurrentDateInConsumptions();
        for (var i = this.selectedConsumedValues.length - 1; i >= 0 ; i--) {
            this.splice('editableConsumption', 
                        this.selectedConsumedValues[i] + baseIndex, 1);
        } 
        
        this.$.deleteToast.opened = true;
    },
    _getSelectedListFromConsumed: function () {
        console.log("_getSelectedListFromConsumed...");
        var newSelectedList = [];
        for (var i = 0; i < this.selectedConsumedValues.length; i++) {
            clone = this.consumption.slice(0);
            delete clone[this.selectedConsumedValues[i]].$key; 
            newSelectedList.push(clone[this.selectedConsumedValues[i]]);
        }
        return newSelectedList;
    },
    _getBaseIndexForCurrentDateInConsumptions: function() {
        var findThisConsumedDate = this.consumption[0].consumedDate;
        for(var i = 0; i < this.editableConsumption.length; i++) {
            if (typeof this.editableConsumption[i] != 'undefined' &&
                findThisConsumedDate === this.editableConsumption[i].consumedDate) {
                return i;
            }
        }
        return -1;
    },
    _consumptionOrDateChanged: function(changeRecord, dateString) {
        if (changeRecord.base.length > 0 &&
            dateString.length > 0) {
            return changeRecord.base;
        }
    },
    formatLocalDate: function (theDate) {
        var now = theDate,
            tzo = -now.getTimezoneOffset(),
            dif = tzo >= 0 ? '+' : '-',
            pad = function(num) {
                var norm = Math.abs(Math.floor(num));
                return (norm < 10 ? '0' : '') + norm;
            };
        return now.getFullYear() 
            + '-' + pad(now.getMonth()+1)
            + '-' + pad(now.getDate())
            + 'T' + pad(now.getHours())
            + ':' + pad(now.getMinutes()) 
            + ':' + pad(now.getSeconds()) 
            + dif + pad(tzo / 60) 
            + ':' + pad(tzo % 60);
       },
      getUnavailableValue: function (value) {
          if (value === "--") {
              return 0;
          }
          else {
              return value;
          }
      }

    });
  </script>
</dom-module>
