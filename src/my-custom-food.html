<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="shared-styles.html">
  <link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-demo-helpers/demo-snippet.html">
  <link rel="import" href="../bower_components/iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
  <link rel="import" href="../bower_components/polymerfire/firebase-query.html">
  <link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="my-icons.html">
  <link rel="import" href="../bower_components/iron-selector/iron-selector.html">
  <link rel="import" href="refresh-custom-food-item.html">
<dom-module id="my-custom-food">
  <template>
    <style is="custom-style" include="demo-pages-shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    form > paper-button {
      width: 45%;
      margin-top: 20px;
    }
    form > paper-button:not([disabled]) {
      background: var(--paper-light-blue-500);
      color: white;
    }
        paper-card {
            width:100%;
        }
    button {
      margin-top: 20px;
    }
       .pad {
          padding: 0 16px;
          @apply(--layout-flex);
          @apply(--layout-horizontal);
        }
        .iron-selected {
          background-color: #3f51b5;
          color: white;
        }
        #scrollingRegion {
          top: 10vh;
          left: 25vh;
          right: 25vh;
          height: 80vh;
          box-shadow: 0 0 60px rgba(0,0,0,0.5);
          overflow: auto;
          -webkit-overflow-scrolling: touch;
        }

    </style>

    <firebase-query
    id="noiQuery"
    app-name="nephcount"
    path="/users/[[user.uid]]/nutrientsOfInterest"
    data="{{nutrientsOfInterest}}">
    </firebase-query>

    <firebase-query
    id="query"
    app-name="nephcount"
    path="/nutrients"
    data="{{possibleNutrients}}">
    </firebase-query>

      <firebase-query id="customFoodQuery"
          app-name="nephcount"
          order-by-child="name"
         path="/users/[[user.uid]]/customFood"
          data="{{customFood}}">
      </firebase-query>

    <refresh-custom-food-item
    id="refreshCustomFoodItemComponent"
    nutrients-of-interest="[[nutrientsOfInterest]]">
    </refresh-custom-food-item>

    <div class="vertical-section-container centered">
     <h1>Define Custom Food Items</h1>
       <form is="iron-form" method="get" action="/" id="theForm">
          <paper-input name="name" label="Name" value="{{foodName}}" required ></paper-input>
          <paper-input name="measure" label="Serving size" required value="{{measure}}" ></paper-input>
          <paper-input name="weight" label="Weight in grams" value="{{weight}}" ></paper-input>

        <template is="dom-repeat" items="[[foodNutrients]]">
            <paper-material elevation="2">
                [[_formatFoodNutrientsItem(item)]]
            </paper-material>
        </template>

           <paper-button raised on-tap="_openAddNutrientDialog">Add A Nutrient</paper-button>
           <hr/>
          <paper-button raised onclick="_submit(event)">Done</paper-button>
          <paper-button raised onclick="_reset(event)">Reset</paper-button>
        </form>

        <paper-dialog id="addNutrientDialog">
            <h2>Nutrients</h2>
                  <paper-dropdown-menu required label="Nutrient" >
                    <paper-listbox class="dropdown-content" selected="{{rowSelectedNutrient}}">
                     <template is="dom-repeat" items='[[_concatNOIWithPossibleNutrients(nutrientsOfInterest.*, possibleNutrients.*)]]' as="possibleNutrient">
                        <paper-item>[[possibleNutrient.name]]</paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>

                    <paper-input value="{{rowValue}}" label="Value" required></paper-input>

                  <paper-dropdown-menu required label="Unit of Measure" >
                    <paper-listbox class="dropdown-content" selected="{{rowSelectedUnit}}" >
                     <template is="dom-repeat" items='[[possibleUnits]]' as="possibleUnit">
                        <paper-item>[[possibleUnit.name]]</paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>

                  <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button dialog-confirm autofocus>Add Nutrient</paper-button>
                  </div>
        </paper-dialog>

        <br/>
        <paper-toolbar>
         <span class="title">Actions on Selected Below</span>
         <paper-icon-button on-tap="_recalculateSelectedCustomFoodsForCurrentNOI"
         icon="my-svg-icons:update"
         alt="Recalculate selected custom foods with current nutrients of interest.">
         </paper-icon-button>
        </paper-toolbar>

        <div id="scrollingRegion">
          <iron-selector multi selected-values="{{selectedCustomFoods}}">
            <template is="dom-repeat" items="[[customFood]]">
                <paper-material elevation="2">
                    [[_formatCustomFoodItem(item)]]
                    <ul>
                    <template is="dom-repeat" items="[[_lookAtCustomFoodNutrients(item.nutrients)]]" as="cfnItem">
                        <li>[[_formatCustomFoodNutrientItem(cfnItem)]]</li>
                    </template>
                        <template is="dom-if" if="{{!_isEmptyArray(item.components)}}">
                            <hr/>
                            <div>made up of...</div>
                        </template>
                    <template is="dom-repeat" items="[[item.components]]" as="cfcItem">
                        <li>
                            [[_formatCustomFoodComponentItem(cfcItem)]]
                        </li>
                    </template>

                    </ul>
                </paper-material>
            </template>
        </iron-selector>
      </div>

      </div>


    </template>

  <script>
    Polymer({
      is: 'my-custom-food',
        properties: {
            user: Object ,
            customFood: {
                type: Array,
                value: []
            },
            ndbno: {
                type: String,
                value: "-1"
            },
            foodName: String,
            measure: String,
            weight: Number,
            foodNutrients: {
                type: Array,
                value: []
            },
            rowSelectedNutrient: {
                type: Number
            },
            rowUnit: String,
            rowSelectedUnit: Number,
            rowValue: String,
            rowGm: {
                type: Number,
                value: -1
            },
            possibleUnits : {
                type: Array,
                value: function () {
                    return [
                        {"name": "milligrams", "abbrev" : "mg"},
                        {"name": "grams", "abbrev" : "g"},
                        {"name": "Calories", "abbrev" : "kcal"},
                        {"name": "liters", "abbrev" : "l"},
                        {"name": "milliliters", "abbrev" : "ml"}
                           ];
                }
            },
            selectedCustomFoods: Array,
            possibleNutrients: Array,
            noiConcatPossibleNutrients: Array
        } ,
                listeners: {
                    'theForm.iron-form-presubmit': '_myPreSubmit',
                    'theForm.iron-form-submit': '_mySubmit',
                    'addNutrientDialog.iron-overlay-closed': '_addDialogClosed'
                },
                observers: [ //'_possibleNutrientsChanged(possibleNutrients.*)',
                             '_userChanged(user.*)'],
        _myPreSubmit : function(event) {
            event.preventDefault;
            var newObject = {
                "ndbno": "01131",
                "name": "Egg, whole, cooked, poached",
                "weight": 50.0,
                "measure": "1.0 large",
                "nutrients": [
                ]
            };
            newObject.name = this.foodName;
            newObject.ndbno = this.ndbno;
            newObject.measure = this.measure;
            newObject.weight = this.weight;
            newObject.nutrients = newObject.nutrients.concat(this.foodNutrients);
            console.log("done constructing new Object...");
            this.$.customFoodQuery.ref.push(newObject);
            // this.push('customFood', newObject);
            this.foodName = null;
            //this.ndbno = null;
            this.measure = null;
            this.weight = null;
            this.foodNutrients = [];
          },
        _mySubmit : function(event) {
          },
        _addDialogClosed: function(event) {
            if (event.detail.confirmed) {
                var foodNutrientObject = {};
                foodNutrientObject.nutrient_id = this.noiConcatPossibleNutrients[this.rowSelectedNutrient].id;
                foodNutrientObject.nutrient = this.noiConcatPossibleNutrients[this.rowSelectedNutrient].name;
                foodNutrientObject.unit = this.possibleUnits[this.rowSelectedUnit].abbrev;
                foodNutrientObject.value = this.rowValue;
                this.push('foodNutrients', foodNutrientObject);
                this.rowSelectedNutrient = {};
                this.rowSelectedUnit = {};
                this.rowValue = null;
            }
            else if (event.detail.cancelled) {
                this.rowSelectedNutrient = {};
                this.rowSelectedUnit = {};
                this.rowValue = null;
            }
        },
        _openAddNutrientDialog: function(event) {
            this.$.addNutrientDialog.open();
        },
        _formatFoodNutrientsItem: function (item) {
            return item.nutrient + " " + item.value + " " + item.unit;
        },
        _formatCustomFoodItem: function(item) {
            return item.measure + " of " + item.name + " weighing " + item.weight + " gm";
        },
        _formatCustomFoodNutrientItem: function(item) {
            return item.nutrient + ", " + item.value + " " + item.unit;
        },
        _formatCustomFoodComponentItem: function(item) {
            return "qty " + item.multiplier + " of " + item.measure + " of "+ item.name + " weighing " + item.consumedGrams + " gm";
        },
        _lookAtCustomFoodNutrients: function(items) {
            return items;
        },
        _userChanged: function(changeRecord) {
            console.log("user changed...");
        },
        _concatNOIWithPossibleNutrients:  function(noiChangeRecord, possibleNutrientsChangeRecord) {
            this.noiConcatPossibleNutrients =  noiChangeRecord.base.concat(possibleNutrientsChangeRecord.base);
            return this.noiConcatPossibleNutrients;
        },
        _isEmptyArray: function(theArray) {
            return typeof theArray === "undefined" || theArray.length === 0;
        },
        _recalculateSelectedCustomFoodsForCurrentNOI: function(event) {
          for (var i = 0; i < this.selectedCustomFoods.length; i++ ) {
              var recalculateThis = this.customFood[this.selectedCustomFoods[i]];
              var recalculatedCustomFoodItem =
                this.$.refreshCustomFoodItemComponent.
                refreshCustomFoodItem(recalculateThis);
          }
        }
    });


        function _submit  (event) {
           Polymer.dom(event).localTarget.parentElement.submit();
        };
       function _reset (event) {
            var form = Polymer.dom(event).localTarget.parentElement
            form.reset();
            form.querySelector('.output').innerHTML = '';
        };

  </script>
</dom-module>
